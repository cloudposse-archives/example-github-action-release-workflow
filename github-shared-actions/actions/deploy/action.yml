name: 'Deploy helmfile EKS'
description: 'Deploy on EKS with helmfile'
inputs:
  stack:
    description: Stack name
    required: true
  aws-region:
    description: AWS region
    required: false
    default: us-east-1
  helmfile-path:
    description: The path where lives the helmfile.
    required: false
    default: deploy
  helmfile:
    description: Helmfile name
    required: false
    default: helmfile.yaml
  operation:
    description: Operation with helmfiles. (valid options - `apply`, `destroy`)
    required: true
    default: apply
  environment:
    description: Helmfile environment
    required: false
    default: preview
  namespace:
    description: Kubernetes namespace
    required: true
  image:
    description: Docker image
    required: true
  image-tag:
    description: Docker image tag
    required: true
outputs:
  webapp-url:
    description: "Web Application url"
    value: https://${{ inputs.namespace }}.${{ inputs.environment }}.example.com
runs:
  using: "composite"
  steps:
  - name: S3 Sync
    uses: giboow/action-aws-cli@v1
    with:
      args: |
        eks --region ${AWS_REGION} update-kubeconfig --name ${CLUSTER_NAME} --role-arn=${CLUSTER_ROLE_ARN}
    env:
      AWS_REGION: ${{ inputs.aws-region }}
      CLUSTER_NAME: cplive-plat-ue2-dev-eks-blue-cluster
      CLUSTER_ROLE: arn:aws:iam::068007702576:role/cplive-plat-gbl-dev-admin
  - shell: sh
    run: |
      sleep $((RANDOM % 10)) && \
      echo "${{ inputs.operation }} ${{ inputs.image }}:${{ inputs.image-tag }} to '${{ inputs.stack }}' stack with '${{ inputs.environment }}' settings in '${{ inputs.namespace }}' namespace"
